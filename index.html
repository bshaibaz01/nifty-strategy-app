<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Nifty Planner — Final Fixed</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { padding:20px; background:#f6f8fb; }
    .card { box-shadow:0 6px 18px rgba(0,0,0,0.06); }
    .log-box { height:180px; overflow:auto; background:#0b1220; color:#cfe8ff; padding:10px; border-radius:6px; font-family:monospace; font-size:13px; }
    .text-profit { color:#0a7a0a; font-weight:600; }
    .text-loss { color:#c82333; font-weight:600; }
  </style>
</head>

<body>

<div class="container">
  <h3 class="mb-3">Nifty Planner — Final Error-Free Version</h3>

  <div class="row g-3">
    <!-- LEFT -->
    <div class="col-lg-5">
      <div class="card p-3">

        <div class="mb-2">
          <label>NIFTY Spot</label>
          <input id="spot" class="form-control" type="number" value="26226">
        </div>

        <div class="row g-2 mb-2">
          <div class="col-6">
            <label>Lot Size</label>
            <input id="lotSize" class="form-control" type="number" value="50">
          </div>
          <div class="col-6">
            <label>Capital</label>
            <input id="capital" class="form-control" type="number" value="100000">
          </div>
        </div>

        <hr>

        <div class="mb-2">
          <label>Safe Distance</label>
          <input id="safeDist" class="form-control" type="number" value="300">
        </div>

        <div class="row g-2">
          <div class="col-6">
            <label>Hedge Distance</label>
            <input id="hedgeDist" class="form-control" value="1000">
          </div>
          <div class="col-6">
            <label>Strike Interval</label>
            <input id="strikeInterval" class="form-control" value="50">
          </div>
        </div>

        <button class="btn btn-warning mt-3" id="autoSuggestBtn">Auto-Suggest</button>

        <hr>

        <div class="row g-2">
          <div class="col-6">
            <label>Sell Call Strike</label>
            <input id="callStrike" class="form-control">
          </div>
          <div class="col-6">
            <label>Sell Put Strike</label>
            <input id="putStrike" class="form-control">
          </div>
        </div>

        <div class="row g-2 mt-2">
          <div class="col-6">
            <label>Hedge Call</label>
            <input id="hedgeCallStrike" class="form-control">
          </div>
          <div class="col-6">
            <label>Hedge Put</label>
            <input id="hedgePutStrike" class="form-control">
          </div>
        </div>

        <hr>

        <div class="form-check form-switch mb-2">
          <input class="form-check-input" id="liveToggle" type="checkbox">
          <label class="form-check-label">Fetch Live Premiums</label>
        </div>

        <div class="row g-2">
          <div class="col-6">
            <label>Call Premium</label>
            <input id="callPremium" class="form-control" value="0">
          </div>
          <div class="col-6">
            <label>Put Premium</label>
            <input id="putPremium" class="form-control" value="0">
          </div>
        </div>

        <div class="d-flex gap-2 mt-3">
          <button id="fetchBtn" class="btn btn-primary">Fetch Now</button>
          <button id="calcBtn" class="btn btn-success">Calculate</button>
        </div>

      </div>
    </div>

    <!-- RIGHT -->
    <div class="col-lg-7">
      <div class="card p-3 mb-3">
        <h6>Scenario Table</h6>
        <table class="table table-bordered table-sm" id="scenarioTable">
          <thead class="table-light">
            <tr><th>Move</th><th>New Spot</th><th>P&L per Lot</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card p-3">
        <h6>Logs</h6>
        <div id="logs" class="log-box"></div>
      </div>
    </div>
  </div>
</div>

<script>

/* Helper */
function el(id){ return document.getElementById(id); }
function log(msg){
  el("logs").innerHTML = `<div>${new Date().toLocaleTimeString()} — ${msg}</div>` + el("logs").innerHTML;
}

function roundStrike(v, step){
  return Math.round(v / step) * step;
}

/* Auto Suggest */
el("autoSuggestBtn").onclick = () => {
  const spotVal = Number(el("spot").value);
  const safe = Number(el("safeDist").value);
  const hedge = Number(el("hedgeDist").value);
  const step = Number(el("strikeInterval").value);

  const sellCall = roundStrike(spotVal + safe, step);
  const sellPut  = roundStrike(spotVal - safe, step);
  const hedgeCall = roundStrike(sellCall + hedge, step);
  const hedgePut  = roundStrike(sellPut - hedge, step);

  el("callStrike").value = sellCall;
  el("putStrike").value  = sellPut;
  el("hedgeCallStrike").value = hedgeCall;
  el("hedgePutStrike").value = hedgePut;

  log(`Auto-selected: CE=${sellCall}, PE=${sellPut}`);
};

/* Fetch Premiums */
async function fetchPremiums(){
  const ce = el("callStrike").value;
  const pe = el("putStrike").value;

  log(`Calling backend for CE=${ce}, PE=${pe}`);

  const res = await fetch(`/fetch-premiums?call=${ce}&put=${pe}`);
  const data = await res.json();

  el("callPremium").value = data.callPremium;
  el("putPremium").value = data.putPremium;

  log(`Fetched: ${JSON.stringify(data)}`);
}

el("fetchBtn").onclick = fetchPremiums;

el("liveToggle").onchange = () => {
  if(el("liveToggle").checked){
    fetchPremiums();
  }
};

/* Calculate Scenario Table */
el("calcBtn").onclick = () => {
  const spot = Number(el("spot").value);
  const ceStrike = Number(el("callStrike").value);
  const peStrike = Number(el("putStrike").value);
  const cp = Number(el("callPremium").value);
  const pp = Number(el("putPremium").value);
  const lot = Number(el("lotSize").value);

  const tbody = el("scenarioTable").querySelector("tbody");
  tbody.innerHTML = "";

  const moves = [100,200,300,400,500,600,700,800,900];
  const full = [...moves, ...moves.map(m=>-m)];

  full.forEach(move => {
    const newSpot = spot + move;
    let pnl = (cp + pp);

    if(newSpot > ceStrike) pnl -= (newSpot - ceStrike);
    if(newSpot < peStrike) pnl -= (peStrike - newSpot);

    pnl *= lot;

    const cls = pnl >= 0 ? "text-profit" : "text-loss";

    tbody.innerHTML += `
      <tr>
        <td>${move >= 0 ? "+"+move : move}</td>
        <td>${newSpot}</td>
        <td class="${cls}">${Math.round(pnl)}</td>
      </tr>`;
  });

  log("Scenario updated");
};

log("Tool loaded successfully.");
</script>

</body>
</html>
